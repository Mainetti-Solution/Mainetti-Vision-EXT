<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema di ContabilitÃ </title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .scaduta { background-color: #fff0f0; }
        .badge-scaduta { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .dashboard-alert { color: #dc3545; font-weight: bold; }
        .rap-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .rap-item:hover { background-color: #f0f8ff; }
        .rap-date { font-size: 12px; color: #666; }
        .rap-client { font-weight: bold; font-size: 14px; }
        .rap-desc { font-size: 12px; font-style: italic; color: #444; }
    </style>
</head>
<body>
    <header>
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <h1>Sistema di ContabilitÃ </h1>
        <img src="img/mainetti_icon.ico" alt="Logo" style="height: 100px; margin-right: 20px;" />
    </div>
        <nav>
            <ul>
                <li><a href="#" class="active" id="nav-dashboard">Dashboard</a></li>
                <li><a href="#" id="nav-fatture">Fatture</a></li>
                <li><a href="#" id="nav-offerte">Offerte</a></li>
                <li><a href="#" id="nav-clienti">Clienti</a></li>
                <li><a href="#" id="nav-servizi">Servizi</a></li>
                <li><a href="#" id="nav-reportistica">Reportistica</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="dashboard" class="sezione-attiva">
            <h2>Dashboard</h2>
            <div class="dashboard-widgets">
                <div class="widget">
                    <h3>Fatture Recenti</h3>
                    <p>Totale fatture: <span id="totale-fatture">0</span></p>
                    <p>Da incassare: <span id="da-incassare">CHF 0.00</span></p>
                </div>
                <div class="widget" id="widget-scadenze" style="border-left: 4px solid #dc3545;">
                    <h3>Allerte Scadenze</h3>
                    <p>Fatture Scadute: <span id="fatture-scadute-count" class="dashboard-alert">0</span></p>
                    <p>Importo a rischio: <span id="fatture-scadute-importo">CHF 0.00</span></p>
                </div>
                <div class="widget">
                    <h3>Offerte Recenti</h3>
                    <p>Totale offerte: <span id="totale-offerte">0</span></p>
                    <p>In attesa: <span id="offerte-in-attesa">CHF 0.00</span></p>
                </div>
                <div class="widget">
                    <h3>Riepilogo Annuale</h3>
                    <p>Fatturato annuo: <span id="fatturato-annuo">CHF 0.00</span></p>
                    <p>Ultimo aggiornamento: <span id="ultimo-aggiornamento">-</span></p>
                </div>
                <div class="widget">
                    <h3>Backup Dati</h3>
                    <button onclick="esportaBackup()">ðŸ’¾ Esporta Backup</button><br><br>
                    <input type="file" onchange="importaBackup(event)" accept=".json">
                </div>
            </div>
        </section>

        <section id="fatture">
            <h2>Gestione Fatture</h2>
            <div class="azioni">
                <button class="btn" id="btn-nuova-fattura">+ Crea Fattura</button>
                <button class="btn" style="background-color: #4ade80; color: #000;" onclick="document.getElementById('file-import-rap').click()">ðŸ“¥ Importa da RAP/EXT</button>
                <input type="file" id="file-import-rap" accept=".json" style="display: none;" onchange="gestisciImportRap(event)">
                <input type="text" id="cerca-fattura" placeholder="Cerca fattura...">
            </div>

            <div class="tabella-container">
                <table id="tabella-fatture">
                    <thead><tr><th>NÂ° Fattura</th><th>Data</th><th>Scadenza</th><th>Cliente</th><th>Importo (CHF)</th><th>Stato</th><th>Azioni</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="form-fattura" class="modal">
                <div class="modal-content">
                    <span class="chiudi">&times;</span>
                    <h3>Nuova Fattura</h3>
                    <form id="fattura-form">
                        <div class="form-row">
                            <div class="form-group"><label for="numero-fattura">Numero Fattura</label><input type="text" id="numero-fattura" required></div>
                            <div class="form-group"><label for="data-fattura">Data</label><input type="date" id="data-fattura" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="cliente-fattura">Cliente</label><select id="cliente-fattura" required><option value="">Seleziona cliente...</option></select></div>
                            <div class="form-group"><label for="stato-fattura">Stato</label><select id="stato-fattura" required><option value="Da pagare">Da pagare</option><option value="Inviata">Inviata</option><option value="Pagata">Pagata</option><option value="Annullata">Annullata</option></select></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="width: 100%;"><label for="riferimento-fattura">Riferimento (Opzionale)</label><input type="text" id="riferimento-fattura" placeholder="Es. Offerta N. 123 o Accordi verbali"></div>
                        </div>
                        <h4>Voci Fattura</h4>
                        <div id="voci-fattura">
                            <div class="voce-fattura">
                                <div class="form-row">
                                    <div class="form-group descrizione-group"><label>Descrizione</label><input type="text" class="descrizione" required></div>
                                    <div class="form-group qta-group"><label>QtÃ </label><input type="number" class="quantita" value="1" min="0.25" step="0.25" required></div>
                                    <div class="form-group prezzo-group"><label>Prezzo (CHF)</label><input type="number" class="prezzo" step="0.01" min="0" required></div>
                                    <div class="form-group sconto-group"><label>Sconto (%)</label><input type="number" class="sconto" value="0" min="0" max="100"></div>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="aggiungi-voce" class="btn-secondary">+ Aggiungi Voce</button>
                        <div class="form-row" style="margin-top: 15px;">
                            <div class="form-group" style="width: 100%;"><label for="concerne-fattura">Concerne</label><input type="text" id="concerne-fattura" class="form-control" placeholder="Descrizione del servizio/prodotto"></div>
                        </div>
                        <div class="totali">
                            <div class="totale-riga"><span>Subtotale:</span><span id="subtotale">CHF 0.00</span></div>
                            <div class="totale-riga"><span>IVA (%):</span><div style="display: flex; align-items: center;"><input type="number" id="iva-globale-fattura" value="0" min="0" max="100" style="width: 60px; margin-right: 10px;"><span id="totale-iva">CHF 0.00</span></div></div>
                            <div class="totale-riga totale-finale"><span>Totale:</span><span id="totale-fattura">CHF 0.00</span></div>
                        </div>
                        <div class="form-row form-actions">
                            <button type="button" class="btn-secondary annulla-form">Annulla</button>
                            <button type="submit" class="btn salva-fattura">Salva Fattura</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section id="offerte" style="display:none"><h2>Gestione Offerte</h2>... (Contenuto standard) ...</section>
        <section id="clienti" style="display:none"><h2>Gestione Clienti</h2>... (Contenuto standard) ...</section>
        <section id="servizi" style="display:none"><h2>Gestione Servizi</h2>... (Contenuto standard) ...</section>
        <section id="reportistica" style="display:none"><h2>Reportistica</h2>... (Contenuto standard) ...</section>
    </main>

    <div id="modal-selezione-rap" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="chiudi" onclick="document.getElementById('modal-selezione-rap').style.display='none'">&times;</span>
            <h3>Seleziona Rapporto da Importare</h3>
            <div id="lista-rap-container" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <footer><p>&copy; <span id="anno-corrente"></span> Sistema di ContabilitÃ  - Tutti i diritti riservati</p></footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    
    <script src="js/script.js"></script>
    <script src="js/pdf_functions.js"></script>
    <script src="js/backup_gestionale.js"></script>
    <script src="js/servizi_predefiniti.js"></script>
    <script src="js/qrbill_integration.js"></script>

    <script>
        // Sovrascriviamo la funzione di importazione per leggere i prezzi
        window.gestisciImportRap = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let json = JSON.parse(e.target.result);
                    // Gestisce sia array (EXT) che oggetto singolo
                    const record = Array.isArray(json) ? json[0] : json;
                    const d = record.data;

                    if(!d) throw new Error("Formato file non valido");

                    // 1. Apri Modale
                    document.getElementById('form-fattura').style.display = 'block';
                    
                    // 2. Compila campi base
                    document.getElementById('data-fattura').value = d.job.date;
                    
                    let rif = d.job.missionId || "";
                    if(d.client.name) rif += " - " + d.client.name;
                    document.getElementById('riferimento-fattura').value = rif;
                    
                    document.getElementById('concerne-fattura').value = d.job.desc || (d.job.loc === "Vendita Esterna" ? "Fornitura Materiale" : "Intervento Tecnico");

                    // 3. Genera righe materiali CON PREZZO
                    const container = document.getElementById('voci-fattura');
                    container.innerHTML = ""; // Pulisce

                    const materials = d.materials || [];
                    if(materials.length === 0) {
                        alert("Nessun materiale nell'ordine!");
                    }

                    materials.forEach(mat => {
                        const div = document.createElement('div');
                        div.className = 'voce-fattura';
                        
                        // LOGICA IMPORTANTE: Se c'Ã¨ 'p' (prezzo) usalo, altrimenti 0
                        const prezzo = mat.p ? parseFloat(mat.p) : 0;
                        const nome = mat.n + (mat.u ? ` (${mat.u})` : "");

                        div.innerHTML = `
                            <div class="form-row">
                                <div class="form-group descrizione-group">
                                    <label>Descrizione</label>
                                    <input type="text" class="descrizione" value="${nome}" required>
                                </div>
                                <div class="form-group qta-group">
                                    <label>QtÃ </label>
                                    <input type="number" class="quantita" value="${mat.q}" min="0" step="0.25" required>
                                </div>
                                <div class="form-group prezzo-group">
                                    <label>Prezzo (CHF)</label>
                                    <input type="number" class="prezzo" value="${prezzo}" step="0.01" min="0" required>
                                </div>
                                <div class="form-group sconto-group">
                                    <label>Sconto (%)</label>
                                    <input type="number" class="sconto" value="0" min="0" max="100">
                                </div>
                                <button type="button" class="btn-remove-row" style="background:#dc3545; color:white; border:none; border-radius:4px; margin-left:5px; cursor:pointer; padding:0 10px;" onclick="this.closest('.voce-fattura').remove()">X</button>
                            </div>
                        `;
                        container.appendChild(div);
                        
                        // Scatena evento input per aggiornare totali (se lo script originale lo ascolta)
                        const inputP = div.querySelector('.prezzo');
                        inputP.dispatchEvent(new Event('input', { bubbles: true }));
                    });

                    // Prova a forzare un ricalcolo simulando un click o input
                    if(container.firstElementChild) {
                        const inputQ = container.firstElementChild.querySelector('.quantita');
                        if(inputQ) inputQ.dispatchEvent(new Event('input', { bubbles: true }));
                    }

                    alert("Import completato! Verifica il cliente e i totali.");

                } catch(err) {
                    alert("Errore durante l'importazione: " + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset per poter ricaricare lo stesso file
        };
    </script>
</body>
</html>